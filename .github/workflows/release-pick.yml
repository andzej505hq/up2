name: Pick commits into a release branch
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request number
        required: true
      branch:
        description: Release branch
        required: true

jobs:
  pick-to-release-branch:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - run: echo "ğŸ”PR number ${{ toJson(github.event.repository.owner) }}"
      - uses: octokit/graphql-action@v2.x
        id: get_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          query: |
            query($owner:String!,$repo:String!,$pr_num:Int!) {
              repository(owner:$owner,name:$repo) {
                pullRequest(number: $pr_num) {
                  commits(first: 100) {
                    totalCount
                    nodes {
                      commit {
                        oid
                        authoredDate
                      }
                    }
                  }
                }
              }
            }
          owner: ${{ github.event.repository.owner.login }}
          repo: ${{ github.event.repository.name }}
          pr_num: ${{ github.event.inputs.pr_number }}
      - name: get commits
        id: commits
        run: |
          commits="$(jq '[.repository.pullRequest.commits.nodes | sort_by(.commit.authoredDate) | .[].commit.oid]' <<< '${{ steps.get_pr.outputs.data }}' | tr -d '\n ')"
          echo "Found commits: ${commits}"
          echo ::set-output name=commits_arr::"${commits}"
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: cherry-pick
        id: show
        run: |
          jq -c '.[]' <<< '${{ steps.commits.outputs.commits_arr }}' | xargs -L 1 -I "{}" git cherry-pick -x
          git push origin ${{ github.event.inputs.branch }}


